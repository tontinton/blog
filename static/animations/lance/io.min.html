<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Parquet vs Lance: I/O Patterns</title><style>*,::after,::before{margin:0;padding:0;box-sizing:border-box}:root{--bg:#242630;--surface:#44475a;--text:#f8f8f2;--muted:#8292c9;--accent:#bd93f9;--gold:#f1fa8c;--green:#50fa7b;--red:#ff5555;--border:rgba(68, 71, 90, 0.5);--mono:'DejaVu Sans Mono',monospace}body{background:var(--bg);color:var(--text);font-family:'DejaVu Sans',sans-serif;display:flex;flex-direction:column;align-items:center;padding:10px;gap:8px}.query-tabs{display:flex;gap:8px}.query-tab{display:flex;flex-direction:column;align-items:flex-start;gap:4px;padding:10px 20px;min-width:280px;background:var(--surface);border:2px solid #333;border-radius:8px;color:var(--text);cursor:pointer;font-size:16px;transition:all .15s}.query-tab:hover{border-color:#555;background:#1e2d50}.query-tab.active{border-color:var(--accent);background:#1e2d50}.query-tab code{font-family:var(--mono);font-size:12px;color:#888}.query-tab.active code{color:#aaf}#canvas-wrapper{width:100%;position:relative}#canvas{position:relative;width:1200px;height:480px;transform-origin:top left}.col-title{position:absolute;top:8px;font-size:17px;font-weight:700;color:#ccc;pointer-events:none;transform:translateX(-50%)}.block{position:absolute;border-radius:5px;display:flex;align-items:center;padding:0 10px;font-family:var(--mono);font-size:12px;border:2px solid transparent;box-shadow:0 1px 4px rgba(0,0,0,.3);overflow:hidden;transition:opacity .3s,filter .3s,border-color .3s,box-shadow .3s}.block.reading{border-color:rgba(255,215,0,.8);box-shadow:0 0 16px rgba(255,215,0,.3),inset 0 0 25px rgba(255,215,0,.08);animation:pulse .9s ease-in-out infinite;z-index:3}.block.completed{border-color:rgba(0,200,83,.5);box-shadow:0 0 10px rgba(0,200,83,.15);z-index:1}.block.skipped{opacity:.28;filter:saturate(.15) brightness(.5)}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}.partial-mask{position:absolute;top:-2px;right:-2px;bottom:-2px;background:rgba(0,0,0,.6);border-radius:0 5px 5px 0;pointer-events:none}.block-divider{position:absolute;top:3px;bottom:3px;width:2px;background:rgba(255,255,255,.2);pointer-events:none}.rg-bracket{position:absolute;width:8px;border-left:1.5px solid rgba(255,255,255,.3);border-top:1.5px solid rgba(255,255,255,.3);border-bottom:1.5px solid rgba(255,255,255,.3)}.rg-label{position:absolute;font-family:var(--mono);font-size:13px;color:rgba(255,255,255,.3);transform:translate(-50%,-50%) rotate(-90deg);white-space:nowrap;pointer-events:none}#step-panel{position:absolute;left:420px;top:29px;width:360px;background:rgba(22,33,62,.95);border:1px solid var(--border);border-radius:10px;padding:14px 16px;z-index:10}.sp-query{font-size:12px;color:var(--muted);text-align:center;font-family:var(--mono);margin-bottom:6px;min-height:14px}.sp-step{font-size:16px;font-weight:700;color:#fff;text-align:center;margin-bottom:2px;min-height:20px}.sp-label{font-size:14px;color:var(--gold);text-align:center;margin-bottom:8px;min-height:18px}.sp-sep{border:none;border-top:1px solid rgba(68,68,119,.3);margin:8px 0}.sp-hdr{font-family:var(--mono);font-size:14px;color:#99b;font-weight:700;margin-bottom:2px}.sp-desc{font-family:var(--mono);font-size:12px;color:#ccc;min-height:26px;line-height:1.4}.sp-sum-title{font-size:14px;font-weight:700;color:#fff;text-align:center;margin-bottom:8px}.sp-sum-line{font-family:var(--mono);font-size:11px;color:#ccc;margin-bottom:4px}.sp-sum-note{font-family:var(--mono);font-size:10px;color:var(--green);font-style:italic;margin-top:6px;line-height:1.4}.io-label{position:absolute;font-family:var(--mono);font-size:12px;font-weight:700;opacity:0;transition:opacity .4s;pointer-events:none;line-height:1.4;z-index:10}.io-label.visible{opacity:1}.note{position:absolute;font-family:var(--mono);font-size:10px;color:var(--muted);pointer-events:none;transform:translateX(-50%)}#svg{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5}.arrow-path{fill:none;stroke-width:2.5;stroke-linecap:round}.arrow-head.faded,.arrow-path.faded{opacity:.25;transition:opacity .4s}.no-transitions,.no-transitions *{transition:none!important}.controls{display:flex;align-items:center;gap:16px;padding:10px 24px;border-radius:8px;margin-top:-10px}.controls button{background:#2a2a4a;color:var(--text);border:1px solid #444;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;transition:all .15s;user-select:none}#btn-play{min-width:100px;height:35px}.controls button:hover:not(:disabled){background:#3a3a5a;border-color:#666}.controls button:disabled{opacity:.4;cursor:default}#speed{width:100px;accent-color:var(--accent)}.controls label{font-size:14px;color:#aaa;display:flex;align-items:center;gap:6px}#speed-val{display:inline-block;width:36px;text-align:right}@media (max-width:900px){.query-tabs{flex-wrap:wrap}.query-tab{min-width:0;flex:1 1 100%;padding:8px 12px;font-size:14px}.query-tab code{font-size:10px}#step-panel{position:static!important;width:auto!important;left:auto!important;top:auto!important;margin:0}.controls{flex-wrap:wrap;gap:8px;padding:8px 12px;justify-content:center;margin-top:0}.controls button{padding:6px 10px;font-size:13px}#btn-play{min-width:80px;height:32px}#speed{width:80px}.controls label{font-size:13px}.io-label{display:none!important}}</style></head><body><div class="query-tabs"><button class="query-tab active" data-query="random"><strong>Random Read</strong> <code>SELECT col_b WHERE id = 100</code></button> <button class="query-tab" data-query="scan"><strong>Sequential Scan</strong> <code>SELECT COUNT(*) GROUP BY col_b</code></button></div><div id="canvas-wrapper"><div id="canvas"><div class="col-title" style="left:220px">Apache Parquet</div><div class="col-title" style="left:980px">Lance</div><div class="note" style="left:980px;top:425px">(no row groups)</div><div class="io-label" id="io-random" style="left:388px;top:206px;color:var(--red)">Random<br>I/O</div><div class="io-label" id="io-seq" style="left:1158px;top:146px;color:var(--green)">Seq.<br>I/O</div><svg id="svg" xmlns="http://www.w3.org/2000/svg"><defs><filter id="glow"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs></svg><div id="step-panel"><div class="sp-query" id="sp-query"></div><div class="sp-step" id="sp-step"></div><div class="sp-label" id="sp-label">Press Play to begin</div><hr class="sp-sep"><div class="sp-hdr">Parquet:</div><div class="sp-desc" id="sp-pq"></div><div class="sp-hdr" style="margin-top:8px">Lance:</div><div class="sp-desc" id="sp-ln"></div></div></div></div><div class="controls"><button id="btn-prev" title="Previous step (&#8592;)">&#9664; Prev</button> <button id="btn-play">&#9208; Pause</button> <button id="btn-next" title="Next step (&#8594;)">Next &#9654;</button> <button id="btn-reset">&#8634; Reset</button> <label>Speed: <span id="speed-val">1&times;</span> <input type="range" id="speed" min="0.25" max="3" step="0.25" value="1"></label></div><script>!function(){"use strict";let e=600;const t="rgba(139,233,253,0.85)",l="rgba(255,184,108,0.85)",a="rgba(80,250,123,0.85)",s="rgba(255,85,85,0.85)",n="rgba(189,147,249,0.85)",o="rgba(98,114,164,0.85)",r=new Set([t,l,a]),c=[{id:"pq-hdr",label:"PAR1 Header (4 B)",color:o,y:29,h:19},{id:"pq-r1a",label:"Col A Chunk (~8 MB)",color:t,y:55,h:31},{id:"pq-r1b",label:"Col B Chunk (~8 MB)",color:l,y:88,h:31},{id:"pq-r1c",label:"Col C Chunk (~8 MB)",color:a,y:121,h:31},{id:"pq-r2a",label:"Col A Chunk (~8 MB)",color:t,y:160,h:31},{id:"pq-r2b",label:"Col B Chunk (~8 MB)",color:l,y:193,h:31},{id:"pq-r2c",label:"Col C Chunk (~8 MB)",color:a,y:226,h:31},{id:"pq-r3a",label:"Col A Chunk (~8 MB)",color:t,y:265,h:31},{id:"pq-r3b",label:"Col B Chunk (~8 MB)",color:l,y:298,h:31},{id:"pq-r3c",label:"Col C Chunk (~8 MB)",color:a,y:331,h:31},{id:"pq-pidx",label:"Page Index (~20 KB)",color:n,y:371,h:22},{id:"pq-meta",label:"File Metadata (~10 KB)",color:s,y:396,h:22},{id:"pq-mlen",label:"Metadata Length (4 B)",color:o,y:422,h:17},{id:"pq-ftr",label:"PAR1 Footer (4 B)",color:o,y:443,h:19}],p=[{id:"ln-a1",label:"Col A - Page 1 (~8 MB)",color:t,y:29,h:31},{id:"ln-a2",label:"Col A - Page 2 (~8 MB)",color:t,y:62,h:31},{id:"ln-a3",label:"Col A - Page 3 (~8 MB)",color:t,y:95,h:31},{id:"ln-b1",label:"Col B - Page 1 (~8 MB)",color:l,y:135,h:31},{id:"ln-b2",label:"Col B - Page 2 (~8 MB)",color:l,y:168,h:31},{id:"ln-b3",label:"Col B - Page 3 (~8 MB)",color:l,y:201,h:31},{id:"ln-c1",label:"Col C - Page 1 (~8 MB)",color:a,y:241,h:31},{id:"ln-c2",label:"Col C - Page 2 (~8 MB)",color:a,y:274,h:31},{id:"ln-c3",label:"Col C - Page 3 (~8 MB)",color:a,y:307,h:31},{id:"ln-cm",label:"Column Metadata (~4 KB)",color:s,y:347,h:22},{id:"ln-ot",label:"Offset Tables (~200 B)",color:n,y:373,h:22},{id:"ln-ft",label:"Footer (40 B)",color:o,y:398,h:19}],d=[{label:"RG 1",top:55,bottom:152},{label:"RG 2",top:160,bottom:257},{label:"RG 3",top:265,bottom:362}],i={random:{sql:"SELECT col_b WHERE id = 100",steps:[{label:"Read Footer",dur:1500,pq:{desc:"Start at the end. Read 8 bytes: a 4-byte metadata length + the PAR1 magic number. The length tells us where the metadata starts.",read:["pq-ftr","pq-mlen"]},ln:{desc:"Read the last 40 bytes: metadata offsets, column count, version info, and the LANC magic. Column count tells us the offset table size, so we know exactly how much to read next.",read:["ln-ft"]}},{label:"Read Metadata",dur:1800,pq:{desc:"Fetch the Thrift-encoded file metadata (TCompactProtocol). It is one blob including: schema, row group boundaries, and column chunk offsets for every column (even though we only need Col B).",read:["pq-meta"],skip:["pq-hdr","pq-r1a","pq-r1b","pq-r1c","pq-r2a","pq-r2b","pq-r2c","pq-r3a","pq-r3b","pq-r3c","pq-pidx"]},ln:{desc:"Read the offset table, then just Col B's column metadata (protobuf). Lance stores metadata per-column, so we skip everything we don't need.",read:["ln-ot","ln-cm"],skip:["ln-a1","ln-a2","ln-a3","ln-b1","ln-b2","ln-b3","ln-c1","ln-c2","ln-c3"]}},{label:"Locate Target",dur:1800,pq:{desc:"Read the page index (optional in Parquet). It has row counts and byte offsets for each page, so we can figure out which page in RG1 contains row 100. If the page index doesn't exist, we simply search the row in all pages.",read:["pq-pidx"],skip:["pq-hdr","pq-r1a","pq-r1b","pq-r1c","pq-r2a","pq-r2b","pq-r2c","pq-r3a","pq-r3b","pq-r3c"]},ln:{desc:"Each page stores its row count in the metadata we already have. Simple math tells us row 100 is in page 1. No extra I/O.",skip:["ln-a1","ln-a2","ln-a3","ln-b1","ln-b2","ln-b3","ln-c1","ln-c2","ln-c3"]}},{label:"Read Target Data",dur:2200,pq:{desc:"Page index told us which page has row 100. Seek into Col B's chunk and read that one page (~1 MB).",read:["pq-r1b"],slice:[.51,.75],skip:["pq-hdr","pq-r1a","pq-r1c","pq-r2a","pq-r2b","pq-r2c","pq-r3a","pq-r3b","pq-r3c"],seek:{from:"pq-pidx",to:"pq-r1b"}},ln:{desc:"Seek to Col B page 1. Metadata includes encoding info per page, so the reader can compute the exact byte range for row 100, and is just a ~64 KB read.",read:["ln-b1"],slice:[.34,.37],skip:["ln-a1","ln-a2","ln-a3","ln-b2","ln-b3","ln-c1","ln-c2","ln-c3","ln-ot"],seek:{from:"ln-cm",to:"ln-b1",color:"#00e676"}}},{label:"Decompressing Page...",dur:2e3,fadeArrows:!0,pq:{desc:"Each page is compressed, and must be decompressed as one unit. A page includes: nullability flags, nesting info, and all values are packed together. No way to jump to row 100 directly.",read:["pq-r1b"],slice:[.51,.75]},ln:{desc:"Lance decodes too, but only the small slice it read (~64 KB). No need to decompress an entire page worth of data."}},{label:"Decode & Filter",dur:1800,pq:{desc:"We know the row offset within the page, but still have to decode from the start of the page to get there. Entire page processed for one row."},ln:{desc:"Lance already decoded its small slice. Parquet is still working through a full page."}}]},scan:{sql:"SELECT COUNT(*) GROUP BY col_b",steps:[{label:"Read Footer",dur:1500,pq:{desc:"Start at the end. Read 8 bytes: a 4-byte metadata length + the PAR1 magic number. The length tells us where the metadata starts.",read:["pq-ftr","pq-mlen"]},ln:{desc:"Read the last 40 bytes: metadata offsets, column count, version info, and the LANC magic. Column count tells us the offset table size, so we know exactly how much to read next.",read:["ln-ft"]}},{label:"Read Metadata",dur:1800,pq:{desc:"Fetch the Thrift-encoded file metadata. We have to parse the whole thing just to find Col B's chunk offsets.",read:["pq-meta"],skip:["pq-hdr","pq-r1a","pq-r1b","pq-r1c","pq-r2a","pq-r2b","pq-r2c","pq-r3a","pq-r3b","pq-r3c","pq-pidx"]},ln:{desc:"Read only Col B's column metadata (protobuf): page offsets, buffer sizes, and encodings for all 3 pages.",read:["ln-cm"],skip:["ln-a1","ln-a2","ln-a3","ln-b1","ln-b2","ln-b3","ln-c1","ln-c2","ln-c3","ln-ot"]}},{label:"Read Col B (1/3)",dur:2e3,pq:{desc:"Seek to RG1 and read Col B's chunk. In Parquet, different columns live together inside each row group: Col A, Col B, Col C, etc...",read:["pq-r1b"],skip:["pq-hdr","pq-r1a","pq-r1c","pq-r2a","pq-r2b","pq-r2c","pq-r3a","pq-r3b","pq-r3c","pq-pidx"],seek:{from:"pq-meta",to:"pq-r1b",color:"#bd93f9"}},ln:{desc:"Start reading Col B page 1. In Lance, all pages for a column sit together.",read:["ln-b1"],skip:["ln-a1","ln-a2","ln-a3","ln-b2","ln-b3","ln-c1","ln-c2","ln-c3","ln-ot"],seek:{from:"ln-cm",to:"ln-b1",color:"#bd93f9"}}},{label:"Read Col B (2/3)",dur:2e3,pq:{desc:"Seek forward, skipping over Col C (RG1) and Col A (RG2) to reach the next Col B chunk.",read:["pq-r2b"],skip:["pq-hdr","pq-r1a","pq-r1c","pq-r2a","pq-r2c","pq-r3a","pq-r3b","pq-r3c","pq-pidx"],seek:{from:"pq-r1b",to:"pq-r2b",color:"#bd93f9"}},ln:{desc:"Keep reading.",read:["ln-b2"],skip:["ln-a1","ln-a2","ln-a3","ln-b3","ln-c1","ln-c2","ln-c3","ln-ot"],seek:{from:"ln-b1",to:"ln-b2",color:"#bd93f9"}}},{label:"Read Col B (3/3)",dur:2e3,pq:{desc:"Another seek, skipping Col C (RG2) and Col A (RG3).",read:["pq-r3b"],skip:["pq-hdr","pq-r1a","pq-r1c","pq-r2a","pq-r2c","pq-r3a","pq-r3c","pq-pidx"],seek:{from:"pq-r2b",to:"pq-r3b",color:"#bd93f9"}},ln:{desc:"Read page 3.",read:["ln-b3"],skip:["ln-a1","ln-a2","ln-a3","ln-c1","ln-c2","ln-c3","ln-ot"],seek:{from:"ln-b2",to:"ln-b3",color:"#bd93f9"}}},{label:"Completing Scan...",dur:1800,fadeArrows:!0,pq:{desc:"Done. Performace is roughly similar, as it's recommended to fetch chunks in parallel after some threshold (e.g. 8MB) on object storages. It doesn\t matter if the chunks are sequential or not."},ln:{desc:"Done."}}]}},h={query:"random",phase:"idle",step:-1,elapsed:0,speed:1,lastTs:0},f=e=>document.querySelector(e),u=e=>document.querySelectorAll(e),b=f("#canvas"),q=f("#svg"),m={query:f("#sp-query"),step:f("#sp-step"),label:f("#sp-label"),pq:f("#sp-pq"),ln:f("#sp-ln"),sumPq:f("#sum-pq"),sumLn:f("#sum-ln"),sumNote:f("#sum-note")},y={random:f("#io-random"),seq:f("#io-seq")},g={play:f("#btn-play"),reset:f("#btn-reset"),prev:f("#btn-prev"),next:f("#btn-next")},k={},C=[];function x(e,t,l){const a=document.createElement("div");a.className="block",Object.assign(a.style,{left:t+"px",top:e.y+"px",width:l+"px",height:e.h+"px",background:e.color,fontSize:(e.h<30?11:12)+"px",color:r.has(e.color)?"rgba(0,0,0,0.95)":"rgba(255,255,255,0.95)"}),a.textContent=e.label,b.appendChild(a),k[e.id]={el:a,x:t,y:e.y,w:l,h:e.h}}function w(e,t){e.forEach(e=>{const l=k[e];for(let e=1;e<t;e++){const a=document.createElement("div");a.className="block-divider",a.style.left=e/t*100+"%",l.el.appendChild(a)}})}function v(e,t){const l=document.createElement("div");l.className="partial-mask",Object.assign(l.style,{left:"-2px",right:"auto",width:100*t[0]+"%",borderRadius:"5px 0 0 5px"}),e.el.appendChild(l);const a=document.createElement("div");a.className="partial-mask",a.style.left=100*t[1]+"%",e.el.appendChild(a)}function B(e,t,l){const a=k[e];if(!a)return;if("skipped"===t)return void(a.el.classList.contains("reading")||a.el.classList.contains("completed")||a.el.classList.add("skipped"));const s="reading"===t&&a.el.classList.contains("reading")||"completed"===t&&a.el.classList.contains("completed");a.el.querySelectorAll(".partial-mask").forEach(e=>e.remove()),l&&(a.slice=l),"idle"===t&&(a.slice=null),s||a.el.classList.remove("reading","completed","skipped"),"reading"===t?(s||a.el.classList.add("reading"),l&&v(a,l)):"completed"===t&&(s||a.el.classList.add("completed"),a.slice&&v(a,a.slice))}function E(e,t){const l=document.createElementNS("http://www.w3.org/2000/svg",e);for(const[e,a]of Object.entries(t))l.setAttribute(e,a);return l}function L(){C.forEach(e=>e.remove()),C.length=0}function R(){C.forEach(e=>{(e.classList.contains("arrow-path")||e.classList.contains("arrow-head"))&&(e.style.opacity="",e.style.transition="",e.classList.add("faded"))})}let M=null,A=null,P=0;function S(e,t){if(!M)return;const l=k[e],a=l.y+l.h-P;!1!==t?(M.style.transition="stroke-dashoffset 0.85s ease-out",A.style.transition="transform 0.85s ease-out"):(M.style.transition="none",A.style.transition="none"),M.style.strokeDashoffset=M.getTotalLength()-a,A.style.transform=`translateY(${a}px)`}function T(){return i[h.query]}function $(e){return e.fadeArrows||e.pq&&e.pq.seek||e.ln&&e.ln.seek}function N(){Object.keys(k).forEach(e=>B(e,"idle")),L(),M=null,A=null,y.random.classList.remove("visible"),y.seq.classList.remove("visible")}function j(){Object.assign(h,{phase:"idle",step:-1,elapsed:0,lastTs:0}),N(),m.query.textContent="",m.step.textContent="",m.label.textContent="Press Play to begin",m.pq.textContent="",m.ln.textContent="",z()}function O(e){const t=T(),l=t.steps[e];m.query.textContent=t.sql,m.step.textContent=`Step ${e+1} / ${t.steps.length}`,m.label.textContent=l.label,m.pq.textContent=l.pq.desc,m.ln.textContent=l.ln.desc}function D(t,l){const a=T().steps[t];["pq","ln"].forEach(t=>{const s=a[t];s.skip&&s.skip.forEach(e=>B(e,"skipped")),s.read&&s.read.forEach(e=>B(e,"reading",s.slice||null)),s.seek&&function(t,l,a,s){const n=k[t],o=k[l],r=n.x<e,c=r?n.x+n.w:n.x,p=n.y+n.h/2,d=r?o.x+o.w:o.x,i=o.y+o.h/2,h=r?Math.max(c,d)+30:Math.min(c,d)-30,f=p+.7*(i-p),u=E("path",{d:`M${c} ${p} C${h} ${p+.3*(i-p)},${h} ${f},${d} ${i}`,stroke:a,"stroke-width":"2.5","stroke-linecap":"round",fill:"none"});u.classList.add("arrow-path"),q.appendChild(u);const b=Math.atan2(i-f,d-h),m=E("polygon",{points:[d,i,d-10*Math.cos(b-.4),i-10*Math.sin(b-.4),d-10*Math.cos(b+.4),i-10*Math.sin(b+.4)].join(","),fill:a});if(m.classList.add("arrow-head"),q.appendChild(m),C.push(u,m),!1!==s){const e=u.getTotalLength();u.style.strokeDasharray=e,u.style.strokeDashoffset=e,m.style.opacity="0",u.getBoundingClientRect(),u.style.transition="stroke-dashoffset 700ms ease-out",u.style.strokeDashoffset="0",setTimeout(()=>{m.classList.contains("faded")||(m.style.transition="opacity 200ms ease-in",m.style.opacity="1")},520)}}(s.seek.from,s.seek.to,s.seek.color||(s.seek.seq?"#00e676":"#ff4444"),l),s.scanStart&&(!function(e){const t=k[e],l=k["ln-b3"];P=t.y;const a=t.x+t.w+14;M=E("path",{d:`M${a} ${P} L${a} ${l.y+l.h}`,stroke:"#00e676","stroke-width":"3","stroke-linecap":"round",fill:"none",filter:"url(#glow)"}),q.appendChild(M);const s=M.getTotalLength();M.style.strokeDasharray=s,M.style.strokeDashoffset=s,A=E("circle",{cx:a,cy:P,r:"5",fill:"#00e676",filter:"url(#glow)"}),q.appendChild(A),C.push(M,A),M.getBoundingClientRect()}(s.read[0]),S(s.read[0],l),y.seq.classList.add("visible")),s.scanCont&&S(s.read[0],l)})}function F(e){const t=T().steps[e];["pq","ln"].forEach(e=>{t[e].read&&t[e].read.forEach(e=>B(e,"completed"))})}function G(e){const t=T();if(e>=t.steps.length)return e>0&&F(e-1),h.phase="finished",void z();const l=t.steps[e];if(e>0){const a=new Set([...l.pq.read||[],...l.ln.read||[]]),s=t.steps[e-1];["pq","ln"].forEach(e=>{s[e].read&&s[e].read.forEach(e=>{a.has(e)||B(e,"completed")})})}$(l)&&R(),h.step=e,h.elapsed=0,O(e),D(e,!0)}function I(e){const t=T();if(!(e<0||e>=t.steps.length)){b.classList.add("no-transitions"),N();for(let l=0;l<e;l++){D(l,!1),F(l);const e=t.steps[l+1];e&&$(e)&&R()}b.classList.remove("no-transitions"),document.body.offsetHeight,h.step=e,h.elapsed=0,O(e),D(e,!0),h.phase="paused",z()}}function z(){g.play.disabled="finished"===h.phase,g.play.textContent="playing"===h.phase?"⏸ Pause":"paused"===h.phase?"▶ Resume":"▶ Play",g.prev.disabled="idle"===h.phase||h.step<=0&&"finished"!==h.phase,g.next.disabled="finished"===h.phase||"idle"!==h.phase&&h.step>=T().steps.length-1}u(".query-tab").forEach(e=>{e.addEventListener("click",()=>{u(".query-tab").forEach(e=>e.classList.remove("active")),e.classList.add("active"),h.query=e.dataset.query,j(),I(0)})}),g.play.addEventListener("click",()=>{"playing"===h.phase?h.phase="paused":"idle"===h.phase||"finished"===h.phase?(j(),h.phase="playing",G(0)):h.phase="playing",z()}),g.reset.addEventListener("click",j),g.prev.addEventListener("click",()=>{"idle"!==h.phase&&I("finished"===h.phase?T().steps.length-1:h.step-1)}),g.next.addEventListener("click",()=>{"idle"===h.phase?(h.phase="paused",G(0)):h.step<T().steps.length-1&&(h.phase="paused",G(h.step+1)),z()}),document.addEventListener("keydown",e=>{const t={ArrowLeft:g.prev,ArrowRight:g.next," ":g.play};t[e.key]&&(t[e.key].click(),e.preventDefault())}),f("#speed").addEventListener("input",function(){h.speed=parseFloat(this.value),f("#speed-val").textContent=h.speed+"×"}),c.forEach(e=>x(e,60,320)),p.forEach(e=>x(e,820,320)),d.forEach(e=>{const t=document.createElement("div");t.className="rg-bracket",Object.assign(t.style,{left:"48px",top:e.top+"px",height:e.bottom-e.top+"px"}),b.appendChild(t);const l=document.createElement("div");l.className="rg-label",Object.assign(l.style,{left:"36px",top:(e.top+e.bottom)/2+"px"}),l.textContent=e.label,b.appendChild(l)}),w(["pq-r1a","pq-r1b","pq-r1c","pq-r2a","pq-r2b","pq-r2c","pq-r3a","pq-r3b","pq-r3c"],4),w(["ln-a1","ln-a2","ln-a3","ln-b1","ln-b2","ln-b3","ln-c1","ln-c2","ln-c3"],30),requestAnimationFrame(function e(t){if("playing"===h.phase){h.lastTs||(h.lastTs=t),h.elapsed+=Math.min(t-h.lastTs,200)*h.speed,h.lastTs=t;const e=T();h.step>=0&&h.step<e.steps.length&&h.elapsed>=e.steps[h.step].dur&&G(h.step+1)}else h.lastTs=0;requestAnimationFrame(e)}),I(0);const K=Array.from(b.querySelectorAll(".col-title")),W=b.querySelector(".note"),H=Array.from(b.querySelectorAll(".rg-bracket")),U=Array.from(b.querySelectorAll(".rg-label"));let Y=null;const _=f("#canvas-wrapper"),J=f("#step-panel"),Q=f(".controls");function V(){const t=window.innerWidth<=900;!function(t){if(t===Y)return;Y=t;const l=t?40:60,a=t?200:320,s=t?280:820,n=t?200:320;if(e=t?250:600,b.style.width=(t?500:1200)+"px",c.forEach(e=>{const t=k[e.id];t.x=l,t.w=a,t.el.style.left=l+"px",t.el.style.width=a+"px"}),p.forEach(e=>{const t=k[e.id];t.x=s,t.w=n,t.el.style.left=s+"px",t.el.style.width=n+"px"}),K[0].style.left=l+a/2+"px",K[1].style.left=s+n/2+"px",W.style.left=s+n/2+"px",H.forEach(e=>e.style.left=l-12+"px"),U.forEach(e=>e.style.left=l-24+"px"),L(),M=null,A=null,h.step>=0&&"idle"!==h.phase){const e=h.phase;I(h.step),"playing"===e&&(h.phase="playing",z())}}(t);const l=t?500:1200,a=_.clientWidth/l;b.style.transform=`scale(${a})`,_.style.height=480*a+"px",t&&J.parentElement===b?Q.parentElement.insertBefore(J,Q):t||J.parentElement===b||b.appendChild(J)}if(new ResizeObserver(V).observe(_),V(),window.frameElement){let e=0;new ResizeObserver(()=>{const t=document.body.scrollHeight;t!==e&&(e=t,window.frameElement.style.height=t+"px")}).observe(document.body)}}()</script></body></html>