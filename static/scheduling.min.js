let W=100;const HIGHLIGHT=112,HIGHLIGHT_TIME=5,RADIUS=.25,DEADLINE_RADIUS=.34,HEIGHT=4;let PROGRESS_WIDTH=8;const CIRCLE_MOVE_TIME=14,QUOTA_CIRCLE_RADIUS=.08;let QUOTA_CIRCLE_PROGRESS_WIDTH=12;const QUOTA_PROGRESS_EXTRA_SIZE=.2,TWO_PI=2*Math.PI;function Tween(n,e,a,i){i=i||!1;let s=1/(e*n),r=0,l=!1;return{update:e=>{e=r+(l?-s:s)*e;r=Math.max(Math.min(e,1),0);let t=l?0===r:1===r;return 1===r&&a&&(l=!0,t=!1,s=1/(a*n)),[i?1-r:r,t]},value:()=>r}}function QueueRect(n,a,i,s,r,l){const t=new PIXI.Graphics;let o=s,d=null,u=[];function p(){let e=0;for(const t of u)t.animateMoveTo(n,a+i-e-1),e++}let I={init:e=>{I.draw(),e.addChild(t)},draw:()=>{t.clear(),t.lineStyle(4,o,1),t.beginFill(o,.05),t.drawRoundedRect(n*W,a*W,W,W*i,W/8),t.endFill()},update:e=>{var t,n,a,i;d&&([e,t]=d.update(e),n=Math.min(((16711680&s)>>16)+Math.round(HIGHLIGHT*e),255)<<16,a=Math.min(((65280&s)>>8)+Math.round(HIGHLIGHT*e),255)<<8,e=Math.min((255&s)+Math.round(HIGHLIGHT*e),255),i=o,(o=n+a+e)!==i&&I.draw(),t)&&(d=null)},pushAnimated:(e,t)=>{e.animateMoveTo(n,a+i-u.length-1,()=>{d=Tween(r,HIGHLIGHT_TIME,HIGHLIGHT_TIME),t&&t(),l&&e.startDeadline()}),u.push(e)},push:e=>{e.updatePosition(n,a+i-u.length-1),l&&e.startDeadline(),u.push(e)},remove:e=>!I.empty()&&(u.splice(u.indexOf(e),1),p(),!0),pop:()=>{if(I.empty())return null;let e;if(l){let t=0;for(let e=1;e<u.length;e++)u[e].deadline()<u[t].deadline()&&(t=e);(e=u.splice(t,1)[0]).stopDeadline()}else e=u.shift();return p(),e},peek:()=>I.empty()?null:u[0],empty:()=>0===u.length};return I}function RunQuota(t,n,a,i,e,s){let r=RoundedRectProgress(e,4,.2,16316658,16733525,s);function l(e){r.update(e),r.draw(a,i)}let o={init:e=>{r.init(a,i,e)},start:e=>{r.start(n,!0,()=>{o.stop(),e()}),t.ticker.add(l)},stop:()=>{t.ticker.remove(l)}};return o}function Cpu(e,n,t,a,i,s,r,l,o,d){const u=QueueRect(i,s,r,l,d);let p=null;function I(e){R.remove(e),t.pushAnimated(e,()=>{e.setState(TaskState.Blocked,a.bind(void 0,e))}),n.empty()||R.pushAnimated(n.pop())}function c(){var e,t;n.empty()||(e=R.pop(),t=n.pop(),e.setState(TaskState.Idle),n.pushAnimated(e),R.pushAnimated(t))}0<o&&(p=RunQuota(e,o,i-QUOTA_PROGRESS_EXTRA_SIZE/2,s-QUOTA_PROGRESS_EXTRA_SIZE/2,1+QUOTA_PROGRESS_EXTRA_SIZE,d));let R={init:e=>{u.init(e),p&&p.init(e)},draw:()=>{u.draw()},update:e=>{u.update(e)},pushAnimated:e=>{u.pushAnimated(e,()=>{e.setState(TaskState.Running,I.bind(void 0,e)),p&&p.start(c)})},push:e=>{u.push(e),p&&p.start(c)},remove:e=>{e=u.remove(e);return e&&p&&p.stop(),e},pop:()=>{var e=u.pop();return e&&p&&p.stop(),e},peek:()=>u.peek(),empty:()=>u.empty(),run:()=>{let e=R.peek();e?(e.setState(TaskState.Running,I.bind(void 0,e)),p&&p.start(c)):(e=n.pop())&&R.pushAnimated(e)}};return R}function CircleProgress(a,i,s,r){const l=new PIXI.Graphics,o=new PIXI.Graphics;l.mask=o;let n=0,d=null,u=null,p=null,I={init:(e,t,n)=>{l.lineStyle(i,s,1),l.drawCircle(e*W,t*W,i+a*W),l.endFill(),I.draw(e,t),n.addChild(l),n.addChild(o)},draw:(e,t)=>{l.position.x=e*W,l.position.y=t*W,o.position.x=e*W,o.position.y=t*W,d!==n&&(e=0-Math.PI/2,t=n+e,o.clear(),o.lineStyle(1,0,1),o.beginFill(0,1),o.moveTo(RADIUS*W,RADIUS*W),o.arc(RADIUS*W,RADIUS*W,i+a*W,e,t,!1),o.endFill()),d=n},update:e=>{var t;u&&([e,t]=u.update(e),n=TWO_PI*e,t)&&(u=null,p)&&p()},start:(e,t,n)=>{u=Tween(r,e,null,!t),p=n},setOnDone:e=>{p=e},stop:()=>{u=null},setPhase:e=>{n=e},isRunning:()=>!!u,value:()=>I.isRunning()?u.value():1};return I}function RoundedRectProgress(a,i,s,r,l,o){l=l||r;const d=new PIXI.Graphics,u=new PIXI.Graphics;d.mask=u;let p=0,n=null,I=null,c=null,R={init:(e,t,n)=>{d.lineStyle(i,p==TWO_PI?l:r,1),d.drawRoundedRect(e*W,t*W,a*W,a*W,s*W),d.endFill(),R.draw(e,t),n.addChild(d),n.addChild(u)},draw:(e,t)=>{u.position.x=e*W,u.position.y=t*W,n!==p&&(e=0-Math.PI/2,t=p+e,u.clear(),u.lineStyle(1,0,1),u.beginFill(0,1),u.moveTo(a/2*W,a/2*W),u.arc(a/2*W,a/2*W,i+a/1.5*W,e,t,!1),u.endFill()),n=p},update:e=>{var t;I&&([e,t]=I.update(e),p=TWO_PI*e,t)&&(I=null,c)&&c()},start:(e,t,n)=>{I=Tween(o,e,null,!t),c=n},stop:()=>{I=null},setPhase:e=>{p=e},isRunning:()=>!!I,value:()=>I?I.value:1};return R}const TaskState=Object.freeze({Idle:Symbol("idle"),Blocked:Symbol("blocked"),Running:Symbol("running")});function TaskCircle(e,t,a,i,n,s){const r=new PIXI.Graphics;r.cacheAsBitmap=!0,r.epsilon=100;let l=0,o=0,d=CircleProgress(RADIUS,PROGRESS_WIDTH,16316658,s),u=e,p=null,I=0<n?CircleProgress(DEADLINE_RADIUS,PROGRESS_WIDTH,12057736,s):null;switch(u){case TaskState.Running:d.setPhase(0),I&&I.setPhase(0);break;case TaskState.Blocked:d.setPhase(TWO_PI),I&&I.setPhase(0);break;case TaskState.Idle:d.setPhase(TWO_PI),I&&I.setPhase(TWO_PI)}let c={init:e=>{r.beginFill(t,1),r.drawCircle((l+RADIUS)*W,(o+RADIUS)*W,RADIUS*W),r.endFill(),d.init(l+RADIUS,o+RADIUS,e),I&&I.init(l+RADIUS,o+RADIUS,e),e.addChild(r)},draw:()=>{r.position.x=(l+RADIUS)*W,r.position.y=(o+RADIUS)*W,d.draw(l+RADIUS,o+RADIUS),I&&I.draw(l+RADIUS,o+RADIUS)},update:e=>{let t=!1;var n;I&&I.isRunning()&&(I.update(e),t=!0),d.isRunning()&&u!==TaskState.Idle&&(d.update(e),t=!0),p&&([e,n]=p.progress.update(e),l=p.startX+(p.endX-p.startX)*e,o=p.startY+(p.endY-p.startY)*e,n&&(e=p.onDone,p=null,e)&&e(),t=!0),t&&c.draw()},setState:(e,t)=>{var n;u=e,d.isRunning()?d.setOnDone(t):u!==TaskState.Running&&u!==TaskState.Blocked||(n=(e=u===TaskState.Running)?a:i*(Math.random()+.5),d.start(n,!e,t))},animateMoveTo:(e,t,n)=>{p?(n&&(p.onDone=n),e==p.endX&&t==p.endY||(p.startX=l,p.startY=o,p.endX=e,p.endY=t,p.progress=Tween(s,CIRCLE_MOVE_TIME))):p={startX:l,endX:e,startY:o,endY:t,onDone:n,progress:Tween(s,CIRCLE_MOVE_TIME)}},updatePosition:(e,t)=>{l=e,o=t,c.draw()},startDeadline:()=>{I&&I.start(n,!1)},stopDeadline:()=>{I&&(I.stop(),I.setPhase(0))},deadline:()=>I?u!==TaskState.Idle?1/0:n-n*I.value():0};return c}function createApp(e,a,t,n,i,s){switch(e){case"small":W=60,PROGRESS_WIDTH=5,QUOTA_CIRCLE_PROGRESS_WIDTH=7;break;case"medium":W=75,PROGRESS_WIDTH=6,QUOTA_CIRCLE_PROGRESS_WIDTH=8;break;case"big":W=100,PROGRESS_WIDTH=8,QUOTA_CIRCLE_PROGRESS_WIDTH=12}s=s||1;const r=new PIXI.Application({backgroundAlpha:0,resizeTo:a,antialias:!0}),l=(r.renderer.view.style.touchAction="auto",QueueRect("big"===e?-2.5:-2,-2,HEIGHT,12424185,t,i)),o=QueueRect("big"===e?1.5:1,-2,HEIGHT,6451876,t),d=[];function u(e){if(o.remove(e)){if(l.empty())for(const t of d)if(t.empty())return void t.pushAnimated(e);e.setState(TaskState.Idle),l.pushAnimated(e)}}for(let e=0;e<s;e++){var p=e*HEIGHT/s,I=HEIGHT/s,p=Cpu(r,l,o,u,-.5,p+I/2-2.5,1,5307003,n,t);d.push(p)}var c=[TaskCircle(TaskState.Running,16733525,84,30,i?440:0,t),TaskCircle(TaskState.Idle,9169405,77,55,i?430:0,t),TaskCircle(TaskState.Idle,16742854,i?9:29,i?13:27,i?50:0,t),TaskCircle(TaskState.Idle,16758892,39,70,i?410:0,t),TaskCircle(TaskState.Idle,15858316,47,35,i?500:0,t)];const R=new PIXI.Container;function S(e,t){R.x=e/2,R.y=t/2}r.stage.addChild(R),S(r.screen.width,r.screen.height),R.pivot.x=R.width/2,R.pivot.y=R.height/2;const T=[l,...d,o,...c];for(const w of T)w.init(R);d[0].push(c[0]);for(let e=1;e<c.length;e++)l.push(c[e]);r.ticker.add(e=>{for(const t of T)t.update(e)});for(const A of d)A.run();r.renderer.on("resize",S),a.appendChild(r.view);let h=()=>{var e=window.scrollY+window.innerHeight+50,t=window.scrollY-50,n=a.offsetTop+a.offsetHeight,e=a.offsetTop<e&&t<n;!r.ticker.started&&e?(r.ticker.start(),r.start()):r.ticker.started&&!e&&(r.ticker.stop(),r.stop())};return window.addEventListener("scroll",h),window.addEventListener("focus",h),window.addEventListener("blur",h),h(),{stop:()=>{window.removeEventListener("scroll",h),window.removeEventListener("focus",h),window.removeEventListener("blur",h),r.stop(),r.destroy(!0)}}}window.createApp=createApp;
